<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Height Prediction Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; background: #f4f8fc; }
    .container { max-width: 960px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
    h1 { text-align: center; color: #222; margin-bottom: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-start; }
    .col { flex: 1 1 220px; min-width: 180px; }
    label { display:block; font-weight:600; margin-top:8px; }
    input, select, button { width:100%; padding:8px 10px; margin-top:6px; border-radius:8px; border:1px solid #ccc; box-sizing:border-box; }
    button { background:#0078D7; color:#fff; font-weight:600; cursor:pointer; }
    button.secondary { background:#555; }
    .controls { margin-top:12px; display:flex; gap:8px; }
    .result { margin-top:18px; padding:14px; background:#e8f4ff; border-radius:10px; border-left:5px solid #0078D7; white-space:pre-wrap; }
    .small { font-size:0.9rem; color:#444; }
    canvas { margin-top:18px; background:#fff; border-radius:8px; padding:8px; }
    .msg { margin-top:8px; font-weight:600; }
    .success { color:green; }
    .error { color:crimson; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Height Prediction Calculator</h1>

    <!-- Prediction Mode (moved to start) -->
    <div class="row">
      <div class="col">
        <label for="mode">Prediction Mode</label>
        <!-- explicit onchange attribute added to guarantee immediate toggle -->
        <select id="mode" aria-label="Prediction mode" onchange="toggleParents()">
          <option value="child">Child only (Percentile-based)</option>
          <option value="child_parents">Child + Parents (Percentile + MPH)</option>
        </select>
      </div>
    </div>

    <!-- Name -->
    <div class="row" style="margin-top:6px;">
      <div class="col">
        <label for="name">Name</label>
        <input id="name" type="text" placeholder="Child's name (optional)">
      </div>
    </div>

    <!-- Location -->
    <div class="row">
      <div class="col">
        <label for="country">Country</label>
        <input id="country" type="text" placeholder="Country">
      </div>
      <div class="col">
        <label for="state">State</label>
        <input id="state" type="text" placeholder="State">
      </div>
      <div class="col">
        <label for="district">District</label>
        <input id="district" type="text" placeholder="District">
      </div>
    </div>

    <!-- Gender, Age, Height -->
    <div class="row">
      <div class="col">
        <label for="gender">Gender</label>
        <select id="gender">
          <option value="Male">Male</option>
          <option value="Female">Female</option>
        </select>
      </div>
      <div class="col">
        <label for="age">Current Age (years, decimals allowed)</label>
        <input id="age" type="number" step="0.01" min="0" max="20" placeholder="e.g. 7.5">
      </div>
      <div class="col">
        <label for="height">Current Height (cm)</label>
        <input id="height" type="number" step="0.1" min="0" placeholder="e.g. 125.4">
      </div>
    </div>

    <!-- Parents Heights (hidden by default) -->
    <div class="row" id="parentsSection" style="display:none; margin-top:8px; align-items:flex-end;">
      <div class="col">
        <label for="father">Father's Height (cm)</label>
        <input id="father" type="number" step="0.1" min="0" placeholder="e.g. 172.0">
      </div>
      <div class="col">
        <label for="mother">Mother's Height (cm)</label>
        <input id="mother" type="number" step="0.1" min="0" placeholder="e.g. 160.0">
      </div>
      <div class="col" style="min-width:160px;">
        <label for="adultAge">Project adult height to age</label>
        <select id="adultAge">
          <option value="18">18 years</option>
          <option value="20">20 years</option>
        </select>
      </div>
    </div>

    <!-- Buttons -->
    <div class="row">
      <div class="col">
        <div class="controls">
          <button id="predictBtn">Predict</button>
          <button id="printBtn" class="secondary">üñ® Print</button>
        </div>
      </div>
    </div>

    <!-- Results -->
    <div id="results" class="result" style="display:none;"></div>
    <div id="logMsg" class="msg" style="display:none;"></div>

    <!-- Chart -->
    <canvas id="growthChart" width="920" height="420"></canvas>
    <div class="small">Red = current, Green = percentile-based predicted, Purple = MPH-based predicted (if parents provided), Blue dashed = trajectory.</div>
  </div>

<script>
/* ------------------
  Configuration ‚Äî put your Apps Script URL here
---------------------*/
const SHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbz73tJdxWhXBMxIjsWcN6WNWLnFkK8OPYpjNIrb0oV5JNj4efTyfDRuh4LMWv7A1BtwaQ/exec";

/* DOM refs */
const modeEl = document.getElementById("mode");
const parentsSection = document.getElementById("parentsSection");
const predictBtn = document.getElementById("predictBtn");
const printBtn = document.getElementById("printBtn");
const resultsEl = document.getElementById("results");
const logMsgEl = document.getElementById("logMsg");
let chart = null;

/* wire up events (also keep onchange on select for robustness) */
document.addEventListener("DOMContentLoaded", () => {
  predictBtn.addEventListener("click", onPredictClicked);
  printBtn.addEventListener("click", () => window.print());
  // ensure parents section initial state matches selected mode
  toggleParents();
});

/* Toggle parents inputs visibility based on mode */
function toggleParents() {
  const mode = modeEl.value;
  if (mode === "child_parents") {
    // use flex so the child .col elements align
    parentsSection.style.display = "flex";
  } else {
    parentsSection.style.display = "none";
    document.getElementById("father").value = "";
    document.getElementById("mother").value = "";
  }
}

/* Utility: fetch JSON file (Male.json / Female.json / male_mph.json etc.) */
async function loadJsonFile(filename) {
  const res = await fetch(filename, { cache: "no-store" });
  if (!res.ok) throw new Error("Could not load " + filename);
  return res.json();
}

/* Predict button handler */
async function onPredictClicked() {
  predictBtn.disabled = true;
  logMsgEl.style.display = "none";
  try {
    await predictHeight();
  } catch (err) {
    resultsEl.style.display = "block";
    resultsEl.innerText = "‚ùå Error: " + (err.message || err);
  } finally {
    predictBtn.disabled = false;
  }
}

/* Main prediction */
async function predictHeight() {
  const mode = modeEl.value;
  const name = document.getElementById("name").value.trim();
  const country = document.getElementById("country").value.trim();
  const state = document.getElementById("state").value.trim();
  const district = document.getElementById("district").value.trim();
  const gender = document.getElementById("gender").value;
  const age = parseFloat(document.getElementById("age").value);
  const currentHeight = parseFloat(document.getElementById("height").value);
  const father = parseFloat(document.getElementById("father").value);
  const mother = parseFloat(document.getElementById("mother").value);
  const adultAge = parseInt(document.getElementById("adultAge").value, 10);

  if (isNaN(age) || isNaN(currentHeight)) {
    resultsEl.style.display = "block";
    resultsEl.innerText = "‚ùå Please enter valid age and current height.";
    return;
  }

  // load main growth dataset
  const mainFile = gender === "Male" ? "Male.json" : "Female.json";
  const mainJson = await loadJsonFile(mainFile);
  const mainData = mainJson.data;

  // interpolation for current age
  let lower = mainData[0];
  for (let i=0;i<mainData.length;i++){
    if (mainData[i].Age <= age) lower = mainData[i]; else break;
  }
  const upper = mainData.find(item => item.Age >= age) || mainData[mainData.length - 1];
  const denom = (upper.Age - lower.Age) || 1;
  const factor = (age - lower.Age) / denom;

  const percentileKeys = Object.keys(lower).filter(k => k !== "Age");
  const interpolated = {};
  percentileKeys.forEach(k => {
    interpolated[k] = Number(lower[k]) + factor * (Number(upper[k]) - Number(lower[k]));
  });

  // nearest percentile
  let nearest = percentileKeys[0];
  let minDiff = Math.abs(interpolated[nearest] - currentHeight);
  percentileKeys.forEach(k => {
    const diff = Math.abs(interpolated[k] - currentHeight);
    if (diff < minDiff) { minDiff = diff; nearest = k; }
  });

  const adultRow = mainData.find(r => r.Age === adultAge) || mainData[mainData.length - 1];
  const predicted_percentileBased = Number(adultRow[nearest]);

  // MPH method
  let mph = null, mphPercentile = null, predicted_mph = null;
  if (mode === "child_parents" && !isNaN(father) && !isNaN(mother)) {
    mph = (father + mother) / 2;
    const mphFile = gender === "Male" ? "male_mph.json" : "female_mph.json";
    const mphJson = await loadJsonFile(mphFile);

    let mphData = [];
    if (Array.isArray(mphJson.data) && mphJson.data.length) mphData = mphJson.data;
    else if (Array.isArray(mphJson)) mphData = mphJson;
    else if (typeof mphJson === "object" && Object.keys(mphJson).length) mphData = mphJson.data ? mphJson.data : [mphJson];

    if (mphData.length) {
      let closest = mphData[0];
      let mdiff = Math.abs(Number(mphData[0].Midparental_m) - mph);
      for (let i=0;i<mphData.length;i++){
        const row = mphData[i];
        const diff = Math.abs(Number(row.Midparental_m) - mph);
        if (diff < mdiff) { mdiff = diff; closest = row; }
      }
      mphPercentile = closest.Percentile;
      if (adultRow[mphPercentile] !== undefined) {
        predicted_mph = Number(adultRow[mphPercentile]);
      }
    }
  }

  // Display simplified results
  let html = "";
  html += `‚úÖ Gender: <b>${gender}</b>\n`;
  html += `‚úÖ Age: <b>${age} years</b>\n`;
  html += `üåç Country: <b>${country || "-"}</b>\n`;
  html += `üèûÔ∏è State: <b>${state || "-"}</b>, District: <b>${district || "-"}</b>\n\n`;
  html += `üìä Predicted Adult Height (Percentile-based): <b>${predicted_percentileBased} cm</b>\n`;
  if (predicted_mph !== null) {
    html += `üìä Predicted Adult Height (MPH-based): <b>${predicted_mph} cm</b>\n`;
  }
  resultsEl.style.display = "block";
  resultsEl.innerHTML = html;

  // Chart
  drawChart(mainData, age, currentHeight, adultAge, predicted_percentileBased, predicted_mph, nearest, mphPercentile);

  // Logging payload
  const payload = {
    timestamp: new Date().toISOString(),
    name: name || "",
    country: country || "",
    state: state || "",
    district: district || "",
    gender,
    age,
    currentHeight,
    percentile_current: nearest,
    predicted_percentileBased,
    father: !isNaN(father) ? father : "",
    mother: !isNaN(mother) ? mother : "",
    mph: mph !== null ? Number(mph.toFixed(2)) : "",
    mph_percentile: mphPercentile || "",
    predicted_mph: predicted_mph !== null ? predicted_mph : ""
  };

  try {
    await logToSheet(payload);
    showLogMessage("üì§ Data saved to Google Sheets ‚úÖ", true);
  } catch (err) {
    console.error("Logging failed:", err);
    showLogMessage("‚ö†Ô∏è Logging to Google Sheets failed.", false);
  }
}

/* Chart function (unchanged) */
function drawChart(mainData, age, currentHeight, adultAge, predicted_percentileBased, predicted_mph, nearestPercentile, mphPercentile) {
  const chartPercentiles = ["P3","P10","P25","P50","P75","P90","P97"];
  const datasets = chartPercentiles.map(p => ({
    label: p,
    data: mainData.map(d => ({ x: d.Age, y: Number(d[p]) })),
    borderColor: getColor(p),
    borderWidth: 2,
    fill: false,
    tension: 0.3,
    pointRadius: 0
  }));

  const trajectory = mainData.filter(d => d.Age >= age && d.Age <= adultAge).map(d => ({ x: d.Age, y: Number(d[nearestPercentile]) }));
  datasets.push({
    label: "Trajectory",
    data: trajectory,
    borderColor: "blue",
    borderWidth: 3,
    borderDash: [6,4],
    fill: false,
    tension: 0,
    pointRadius: 0
  });

  datasets.push({
    label: "Current",
    data: [{ x: age, y: currentHeight }],
    backgroundColor: "red",
    borderColor: "red",
    pointRadius: 6,
    type: "scatter"
  });

  datasets.push({
    label: "Predicted (Percentile)",
    data: [{ x: adultAge, y: predicted_percentileBased }],
    backgroundColor: "green",
    borderColor: "green",
    pointRadius: 6,
    type: "scatter"
  });

  if (predicted_mph !== null && predicted_mph !== undefined && predicted_mph !== "") {
    datasets.push({
      label: "Predicted (MPH)",
      data: [{ x: adultAge, y: predicted_mph }],
      backgroundColor: "purple",
      borderColor: "purple",
      pointRadius: 6,
      type: "scatter"
    });

    if (mphPercentile && mainData[0].hasOwnProperty(mphPercentile)) {
      const mphTrajectory = mainData.filter(d => d.Age >= age && d.Age <= adultAge).map(d => ({ x: d.Age, y: Number(d[mphPercentile]) }));
      datasets.push({
        label: "MPH Trajectory",
        data: mphTrajectory,
        borderColor: "purple",
        borderWidth: 2,
        borderDash: [3,3],
        fill: false,
        tension: 0,
        pointRadius: 0
      });
    }
  }

  if (chart) chart.destroy();
  const ctx = document.getElementById("growthChart").getContext("2d");
  chart = new Chart(ctx, {
    type: "line",
    data: { datasets },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "bottom" },
        tooltip: {
          callbacks: {
            label: c => `${c.dataset.label}: ${c.parsed.y} cm at age ${c.parsed.x}`
          }
        }
      },
      scales: {
        x: { type: "linear", title: { display: true, text: "Age (years)" } },
        y: { title: { display: true, text: "Height (cm)" } }
      }
    }
  });
}

function getColor(p) {
  const map = { "P3":"#ff6384","P10":"#ff9f40","P25":"#ffcd56","P50":"#4bc0c0","P75":"#36a2eb","P90":"#9966ff","P97":"#c9cbcf" };
  return map[p] || "#666";
}

/* Logging helper */
async function logToSheet(payload) {
  const res = await fetch(https://script.google.com/macros/s/AKfycbzOGqTLTZNpCmStuqPh1v70pV0t5-6_aNFAYXK8921kvud5VMZAmkZvUSrzud8pot-rhQ/exec, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });
  if (!res.ok) {
    const txt = await res.text().catch(()=>res.statusText);
    throw new Error("Sheet logging failed: " + txt);
  }
  return res.text().catch(()=>"ok");
}

/* UI log message */
function showLogMessage(msg, ok=true) {
  logMsgEl.style.display = "block";
  logMsgEl.innerText = msg;
  logMsgEl.className = ok ? "msg success" : "msg error";
  setTimeout(()=> { logMsgEl.style.display = "none"; }, 6000);
}

/* draw skeleton chart initially */
async function initSkeletonChart() {
  try {
    const json = await loadJsonFile("Male.json");
    drawChart(json.data, 0, 0, 18, 0, null, "P50", null);
  } catch (e) { /* ignore */ }
}
initSkeletonChart();
</script>
</body>
</html>

